services:
  db:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-atri}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-114514}"
      POSTGRES_DB: "${POSTGRES_DB:-atri}"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    ports:
      # 生产环境推荐：只监听本地（改为 "127.0.0.1:5433:5432"）
      # 开发环境：如需外部访问数据库，保持 "5433:5432"
      # 注意：宿主机 5432 端口已被 remoteplc_server 占用，故改为 5433
      - "127.0.0.1:5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-atri} -d ${POSTGRES_DB:-atri}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - atri-net

  api:
    build: .
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # 基础配置（默认会从同目录 .env 读取；也可以直接改这里）
      DATABASE_URL: "${DATABASE_URL:-postgres://atri:114514@db:5432/atri}"
      MEDIA_ROOT: "${MEDIA_ROOT:-/data/media}"
      HOST: "${HOST:-0.0.0.0}"
      PORT: "${PORT:-3111}"
      # MQTT 配置 (参考 remoteplc_server)
      # MQTT_BROKER_HOST: "${MQTT_BROKER_HOST:-mqtt.example.com}"
      # MQTT_BROKER_PORT: "${MQTT_BROKER_PORT:-1883}"
      # MQTT_USERNAME: "${MQTT_USERNAME:-mqtt_test}"
      # MQTT_PASSWORD: "${MQTT_PASSWORD:-114514}"
      # MQTT_CLIENT_ID: "${MQTT_CLIENT_ID:-atri-server}"
      # 下面这些请自行配置为真实值（不要提交到 Git）
      APP_TOKEN: "${APP_TOKEN:-}"
      OPENAI_API_URL: "${OPENAI_API_URL:-}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      EMBEDDINGS_API_URL: "${EMBEDDINGS_API_URL:-https://api.siliconflow.cn/v1}"
      EMBEDDINGS_API_KEY: "${EMBEDDINGS_API_KEY:-}"
      EMBEDDINGS_MODEL: "${EMBEDDINGS_MODEL:-BAAI/bge-m3}"
      DIARY_API_URL: "${DIARY_API_URL:-}"
      DIARY_API_KEY: "${DIARY_API_KEY:-}"
      DIARY_MODEL: "${DIARY_MODEL:-}"
      MEDIA_SIGNING_KEY: "${MEDIA_SIGNING_KEY:-}"
      ADMIN_API_KEY: "${ADMIN_API_KEY:-}"
      ADMIN_CONFIG_ENCRYPTION_KEY: "${ADMIN_CONFIG_ENCRYPTION_KEY:-}"
      ADMIN_ALLOWED_IPS: "${ADMIN_ALLOWED_IPS:-}"
      TAVILY_API_KEY: "${TAVILY_API_KEY:-}"
      PUBLIC_BASE_URL: "${PUBLIC_BASE_URL:-}"
    volumes:
      - ./data/media:/data/media
      - ./data/import:/data/import
    ports:
      - "3111:3111"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - atri-net

networks:
  atri-net:
    driver: bridge
