<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ATRI 控制台</title>
    <link rel="stylesheet" href="/admin/assets/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="card card--header">
        <div class="inline inline-between">
          <div>
            <div class="brand-title">ATRI 管理后台</div>
            <div class="muted">默认只允许本机/SSH 隧道访问；如需公网访问与安全说明请看「概览」。</div>
          </div>
          <div class="inline">
            <button id="themeToggleBtn" class="secondary sm" type="button">主题</button>
            <span id="sessionStatus" class="muted">未登录</span>
            <button id="logoutBtn" class="secondary" type="button" hidden>退出</button>
          </div>
        </div>
      </div>

      <div id="loginCard" class="card">
        <div class="card-title">登录</div>
        <div class="row">
          <div class="col">
            <label for="apiKey">ADMIN_API_KEY</label>
            <input id="apiKey" type="password" placeholder="输入管理员密钥" autocomplete="current-password" />
          </div>
        </div>
        <div class="inline mt-10">
          <button id="loginBtn" type="button">登录</button>
          <span id="loginMsg" class="muted"></span>
        </div>
      </div>

      <div id="app" hidden>
        <div class="card">
          <div class="tabs" role="tablist" aria-label="管理后台导航">
            <button class="tab active" type="button" data-tab="config" role="tab" aria-selected="true">运行时配置</button>
            <button class="tab" type="button" data-tab="overview" role="tab" aria-selected="false">概览</button>
            <button class="tab" type="button" data-tab="prompts" role="tab" aria-selected="false">提示词</button>
            <button class="tab" type="button" data-tab="conversation" role="tab" aria-selected="false">对话</button>
            <button class="tab" type="button" data-tab="logs" role="tab" aria-selected="false">日志</button>
          </div>
        </div>

        <div id="tab-config" class="card" role="tabpanel">
          <div class="muted small">说明：这里改的是“运行时配置”（存 DB），保存后立刻生效，不用重启容器。</div>
          <div id="configMeta" class="muted small mt-6"></div>

          <div class="section-title mt-18">聊天上游</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="chatApiFormat">聊天上游 API 格式</label>
                <select id="chatApiFormat">
                  <option value="openai">OpenAI</option>
                  <option value="anthropic">Anthropic</option>
                  <option value="gemini">Gemini</option>
                </select>
                <div class="muted small mt-6">决定“聊天上游”的请求/响应格式（支持工具调用与图片）。</div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="openaiApiUrl">聊天上游 API 地址</label>
                <input id="openaiApiUrl" placeholder="https://api.openai.com" />
                <div class="muted small mt-6">
                  只需要填到版本号之前（不要带 /v1）；后台会自动补全：OpenAI/Anthropic → /v1，Gemini → /v1beta。
                </div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="defaultChatModel">默认聊天模型</label>
                <input id="defaultChatModel" placeholder="gpt-4o" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="openaiApiKey">聊天上游 API Key</label>
                <input id="openaiApiKey" type="password" placeholder="留空则保持不变" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearOpenaiApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="openaiKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="anthropicVersion">Anthropic-Version（仅 Anthropic 需要）</label>
                <input id="anthropicVersion" placeholder="2023-06-01" />
                <div class="muted small mt-6">不确定就用默认值 `2023-06-01`。</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">联网搜索（可选）</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="tavilyApiKey">Tavily API Key</label>
                <input id="tavilyApiKey" type="password" placeholder="留空则保持不变" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearTavilyApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="tavilyKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">向量 / Embeddings</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="embeddingsApiUrl">Embeddings API 地址</label>
                <input id="embeddingsApiUrl" placeholder="https://api.siliconflow.cn/v1" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="embeddingsModel">Embeddings 模型</label>
                <input id="embeddingsModel" placeholder="BAAI/bge-m3" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="embeddingsApiKey">Embeddings API Key</label>
                <input id="embeddingsApiKey" type="password" placeholder="留空则保持不变" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearEmbeddingsApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="embeddingsKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">日记上游（可选）</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="diaryApiFormat">日记上游 API 格式（可选）</label>
                <select id="diaryApiFormat">
                  <option value="">跟随聊天上游</option>
                  <option value="openai">OpenAI</option>
                  <option value="anthropic">Anthropic</option>
                  <option value="gemini">Gemini</option>
                </select>
                <div class="muted small mt-6">不选就沿用“聊天上游”格式。</div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="diaryApiUrl">日记 API 地址（可选）</label>
                <input id="diaryApiUrl" placeholder="留空则使用聊天上游配置" />
                <div class="muted small mt-6">同样只填到版本号之前（不要带 /v1 或 /v1beta）。</div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="diaryApiKey">日记 API Key</label>
                <input id="diaryApiKey" type="password" placeholder="留空则使用聊天上游 Key" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearDiaryApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="diaryKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="diaryModel">日记模型（可选）</label>
                <input id="diaryModel" placeholder="日记生成使用的模型" />
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">生成参数</div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="agentTemperature">聊天 Temperature</label>
                <input id="agentTemperature" placeholder="1.0" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="agentMaxTokens">聊天 Max Tokens</label>
                <input id="agentMaxTokens" placeholder="4096" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="diaryTemperature">日记 Temperature</label>
                <input id="diaryTemperature" placeholder="0.7" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="diaryMaxTokens">日记 Max Tokens</label>
                <input id="diaryMaxTokens" placeholder="4096" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="profileTemperature">档案 Temperature</label>
                <input id="profileTemperature" placeholder="0.2" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="selfReviewTemperature">便签 Temperature</label>
                <input id="selfReviewTemperature" placeholder="0.2" />
              </div>
            </div>
          </div>

          <div class="inline mt-18">
            <button id="saveConfigBtn" type="button">保存配置</button>
            <button id="resetConfigBtn" class="secondary" type="button">重置为 .env</button>
            <span id="configMsg" class="muted"></span>
          </div>

          <div class="divider"></div>
          <div class="section-title">连接测试</div>
          <div class="inline">
            <button id="testDbBtn" class="secondary sm" type="button">数据库</button>
            <button id="testOpenaiBtn" class="secondary sm" type="button">聊天上游</button>
            <button id="testEmbeddingsBtn" class="secondary sm" type="button">Embeddings</button>
            <span id="toolsMsg" class="muted"></span>
          </div>
          <div id="toolsOut" class="log log--small mt-12"></div>
        </div>

        <div id="tab-overview" class="card" role="tabpanel" hidden>
          <div class="muted small">说明：这里展示部署信息与后台安全模式（方便你排查“为啥打不开/为啥跨域”）。</div>

          <div class="row mt-10">
            <div class="col">
              <label for="overviewBaseUrl">当前访问地址</label>
              <div class="inline inline-stretch">
                <input id="overviewBaseUrl" readonly />
                <button id="copyOverviewBaseUrlBtn" class="secondary sm" type="button">复制</button>
              </div>
              <div id="overviewMsg" class="muted small mt-6"></div>
            </div>
            <div class="col">
              <label>后台模式</label>
              <div id="overviewMode" class="muted"></div>
              <div class="muted small mt-6">
                公网访问需要设置 `ADMIN_PUBLIC=1`，并建议设置 `ADMIN_ALLOWED_ORIGINS`（以及 `PUBLIC_BASE_URL`）。
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">允许的 Origin</div>
          <div class="muted small">公网模式下，后台 API 会校验 Origin，防止跨站请求。</div>
          <div id="overviewOrigins" class="log log--small mt-12"></div>

          <div class="divider"></div>
          <div class="section-title">自动更新（Zeabur / GitHub）</div>
          <div class="muted small">
            代码更新一般不需要在后台点“同步”：把项目绑定到 GitHub 后，Zeabur 会在你 push 代码时自动构建并发布。
          </div>
          <div id="overviewBuildInfo" class="muted small mt-10"></div>

          <div class="inline mt-12">
            <button id="refreshOverviewBtn" class="secondary" type="button">刷新</button>
          </div>
        </div>

        <div id="tab-prompts" class="card" role="tabpanel" hidden>
          <div class="muted small">说明：这里是提示词“表单编辑”，不用你手写 JSON。保存后立刻生效。</div>
          <div class="divider"></div>
          <div class="section-title">从 GitHub 导入（可选）</div>
          <div class="row">
            <div class="col">
              <label for="promptsImportUrl">Raw JSON 地址（raw.githubusercontent.com / gist.githubusercontent.com）</label>
              <input id="promptsImportUrl" placeholder="https://raw.githubusercontent.com/<owner>/<repo>/<branch>/path/prompts.json" />
              <div class="muted small mt-6">会直接覆盖为该文件内容（要求结构与本后台提示词一致）。</div>
              <div class="field-hint mt-10">
                <input id="promptsAutoSync" type="checkbox" />
                <span>每次登录后台时自动从该地址同步（覆盖）</span>
              </div>
            </div>
          </div>
          <div class="inline mt-12">
            <button id="importPromptsBtn" class="secondary" type="button">导入并覆盖</button>
            <span id="promptsImportMsg" class="muted"></span>
          </div>
          <div class="divider"></div>
          <div class="row">
            <div class="col">
              <label for="p_agent_system">agent.system</label>
              <textarea id="p_agent_system"></textarea>
            </div>
            <div class="col">
              <label for="p_diary_system">diary.system</label>
              <textarea id="p_diary_system"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="p_diary_userTemplate">diary.userTemplate</label>
              <textarea id="p_diary_userTemplate"></textarea>
            </div>
            <div class="col">
              <label for="p_profile_system">profile.system</label>
              <textarea id="p_profile_system"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="p_profile_userTemplate">profile.userTemplate</label>
              <textarea id="p_profile_userTemplate"></textarea>
            </div>
            <div class="col">
              <label for="p_sticky_system">stickyNote.system</label>
              <textarea id="p_sticky_system"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="p_sticky_userTemplate">stickyNote.userTemplate</label>
              <textarea id="p_sticky_userTemplate"></textarea>
            </div>
          </div>

          <div class="inline mt-12">
            <button id="savePromptsBtn" type="button">保存提示词</button>
            <button id="resetPromptsBtn" class="secondary" type="button">恢复默认</button>
            <span id="promptsMsg" class="muted"></span>
          </div>
        </div>

        <div id="tab-logs" class="card" role="tabpanel" hidden>
          <div class="muted small">说明：这是“应用层”错误日志（内存最多 1000 条），支持实时流。</div>
          <div class="inline mt-10">
            <button id="refreshLogsBtn" class="secondary" type="button">刷新</button>
            <button id="toggleStreamBtn" class="secondary" type="button">开始实时</button>
            <span id="logsMsg" class="muted"></span>
          </div>
          <div id="logsBox" class="log mt-10"></div>
        </div>

        <div id="tab-conversation" class="card" role="tabpanel" hidden>
          <div class="muted small">说明：按 userId 拉取并查看对话日志（用于排障/同步检查）。</div>
          <div class="row mt-10">
            <div class="col">
              <label for="convUserId">userId</label>
              <input id="convUserId" placeholder="例如：xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
            </div>
            <div class="col">
              <label for="convRole">role（可选）</label>
              <input id="convRole" placeholder="user,atri 或留空" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="convAfter">after（timestamp，毫秒）</label>
              <input id="convAfter" placeholder="0" />
            </div>
            <div class="col">
              <label for="convLimit">limit</label>
              <input id="convLimit" placeholder="50" />
            </div>
          </div>
          <div class="inline mt-12">
            <button id="convPullBtn" class="secondary" type="button">拉取</button>
            <button id="convNextBtn" class="secondary" type="button">继续拉取</button>
            <button id="convClearBtn" class="secondary" type="button">清空输出</button>
            <span id="convMsg" class="muted"></span>
          </div>
          <div id="convOut" class="log mt-10"></div>
        </div>
      </div>
    </div>

    <script type="module" src="/admin/assets/app.js"></script>
  </body>
</html>
