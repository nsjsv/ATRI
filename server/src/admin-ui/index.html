<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ATRI Console</title>
    <link rel="stylesheet" href="/admin/assets/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="card card--header">
        <div class="inline inline-between">
          <div>
            <div class="brand-title">ATRI Console</div>
            <div class="muted small">默认只允许本机访问，公网访问请查看「概览」中的安全说明。</div>
          </div>
          <div class="inline">
            <button id="themeToggleBtn" class="secondary sm" type="button">切换主题</button>
            <span id="sessionStatus" class="muted">未登录</span>
            <button id="logoutBtn" class="secondary sm" type="button" hidden>退出</button>
          </div>
        </div>
      </div>

      <div id="loginCard" class="card">
        <div class="card-title">登录</div>
        <div class="field">
          <label for="apiKey">管理密钥</label>
          <input id="apiKey" type="password" placeholder="输入 ADMIN_API_KEY" autocomplete="current-password" />
        </div>
        <div class="inline mt-18">
          <button id="loginBtn" type="button">登录</button>
          <span id="loginMsg" class="muted"></span>
        </div>
      </div>

      <div id="app" hidden>
        <div class="card">
          <div class="tabs" role="tablist" aria-label="导航">
            <button class="tab active" type="button" data-tab="config" role="tab" aria-selected="true">配置</button>
            <button class="tab" type="button" data-tab="overview" role="tab" aria-selected="false">概览</button>
            <button class="tab" type="button" data-tab="prompts" role="tab" aria-selected="false">提示词</button>
            <button class="tab" type="button" data-tab="conversation" role="tab" aria-selected="false">对话</button>
            <button class="tab" type="button" data-tab="logs" role="tab" aria-selected="false">日志</button>
          </div>
        </div>

        <!-- 配置 Tab -->
        <div id="tab-config" class="card" role="tabpanel">
          <div class="muted small">运行时配置，保存后立即生效，无需重启。</div>
          <div id="configMeta" class="muted small mt-6"></div>

          <div class="section-title mt-18">聊天上游</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="chatApiFormat">API 格式</label>
                <select id="chatApiFormat">
                  <option value="openai">OpenAI</option>
                  <option value="anthropic">Anthropic</option>
                  <option value="gemini">Gemini</option>
                </select>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="openaiApiUrl">API 地址</label>
                <input id="openaiApiUrl" placeholder="https://api.openai.com" />
                <div class="muted small mt-6">填到版本号之前，不要带 /v1</div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="defaultChatModel">默认模型</label>
                <input id="defaultChatModel" placeholder="gpt-4o" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="openaiApiKey">API Key</label>
                <input id="openaiApiKey" type="password" placeholder="留空则保持不变" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearOpenaiApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="openaiKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="anthropicVersion">Anthropic-Version</label>
                <input id="anthropicVersion" placeholder="2023-06-01" />
                <div class="muted small mt-6">仅 Anthropic 格式需要</div>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">联网搜索</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="tavilyApiKey">Tavily API Key</label>
                <input id="tavilyApiKey" type="password" placeholder="留空则保持不变" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearTavilyApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="tavilyKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">向量 / Embeddings</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="embeddingsApiUrl">API 地址</label>
                <input id="embeddingsApiUrl" placeholder="https://api.siliconflow.cn/v1" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="embeddingsModel">模型</label>
                <input id="embeddingsModel" placeholder="BAAI/bge-m3" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="embeddingsApiKey">API Key</label>
                <input id="embeddingsApiKey" type="password" placeholder="留空则保持不变" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearEmbeddingsApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="embeddingsKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">日记上游（可选）</div>
          <div class="row">
            <div class="col">
              <div class="field">
                <label for="diaryApiFormat">API 格式</label>
                <select id="diaryApiFormat">
                  <option value="">跟随聊天上游</option>
                  <option value="openai">OpenAI</option>
                  <option value="anthropic">Anthropic</option>
                  <option value="gemini">Gemini</option>
                </select>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="diaryApiUrl">API 地址</label>
                <input id="diaryApiUrl" placeholder="留空则使用聊天上游" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="diaryApiKey">API Key</label>
                <input id="diaryApiKey" type="password" placeholder="留空则使用聊天上游" autocomplete="off" />
                <div class="field-hint">
                  <input id="clearDiaryApiKey" type="checkbox" />
                  <span>清空已保存</span>
                  <span id="diaryKeyFlag" class="tag"></span>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="diaryModel">模型</label>
                <input id="diaryModel" placeholder="日记生成使用的模型" />
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">生成参数</div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="agentTemperature">聊天 Temperature</label>
                <input id="agentTemperature" placeholder="1.0" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="agentMaxTokens">聊天 Max Tokens</label>
                <input id="agentMaxTokens" placeholder="4096" />
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <div class="field">
                <label for="diaryTemperature">日记 Temperature</label>
                <input id="diaryTemperature" placeholder="0.7" />
              </div>
            </div>
            <div class="col">
              <div class="field">
                <label for="diaryMaxTokens">日记 Max Tokens</label>
                <input id="diaryMaxTokens" placeholder="4096" />
              </div>
            </div>
          </div>

	          <div class="row">
	            <div class="col">
	              <div class="field">
	                <label for="profileTemperature">档案 Temperature</label>
	                <input id="profileTemperature" placeholder="0.2" />
	              </div>
	            </div>
	          </div>

          <div class="inline mt-18">
            <button id="saveConfigBtn" type="button">保存配置</button>
            <button id="resetConfigBtn" class="secondary" type="button">重置为 .env</button>
            <span id="configMsg" class="muted"></span>
          </div>

          <div class="divider"></div>
          <div class="section-title">连接测试</div>
          <div class="inline">
            <button id="testDbBtn" class="secondary sm" type="button">数据库</button>
            <button id="testOpenaiBtn" class="secondary sm" type="button">聊天上游</button>
            <button id="testEmbeddingsBtn" class="secondary sm" type="button">Embeddings</button>
            <span id="toolsMsg" class="muted"></span>
          </div>
          <div id="toolsOut" class="log log--small mt-12"></div>
        </div>

        <!-- 概览 Tab -->
        <div id="tab-overview" class="card" role="tabpanel" hidden>
          <div class="muted small">部署信息与安全模式</div>

          <div class="row mt-10">
            <div class="col">
              <label for="overviewBaseUrl">当前访问地址</label>
              <div class="inline inline-stretch">
                <input id="overviewBaseUrl" readonly />
                <button id="copyOverviewBaseUrlBtn" class="secondary sm" type="button">复制</button>
              </div>
              <div id="overviewMsg" class="muted small mt-6"></div>
            </div>
            <div class="col">
              <label>后台模式</label>
              <div id="overviewMode" class="muted"></div>
              <div class="muted small mt-6">
                公网访问需设置 ADMIN_PUBLIC=1，建议同时设置 ADMIN_ALLOWED_ORIGINS。
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="section-title">允许的 Origin</div>
          <div class="muted small">公网模式下会校验 Origin，防止跨站请求。</div>
          <div id="overviewOrigins" class="log log--small mt-12"></div>

          <div class="divider"></div>
          <div class="section-title">自动更新</div>
          <div class="muted small">
            绑定 GitHub 后，Zeabur 会在 push 时自动构建发布。
          </div>
          <div id="overviewBuildInfo" class="muted small mt-10"></div>

          <div class="inline mt-12">
            <button id="refreshOverviewBtn" class="secondary" type="button">刷新</button>
          </div>
        </div>

        <!-- 提示词 Tab -->
        <div id="tab-prompts" class="card" role="tabpanel" hidden>
          <div class="muted small">提示词编辑，保存后立即生效。</div>

          <div class="divider"></div>
          <div class="section-title">从 GitHub 导入</div>
          <div class="row">
            <div class="col">
              <label for="promptsImportUrl">Raw JSON 地址</label>
              <input id="promptsImportUrl" placeholder="https://raw.githubusercontent.com/..." />
              <div class="field-hint mt-10">
                <input id="promptsAutoSync" type="checkbox" />
                <span>每次登录时自动同步</span>
              </div>
            </div>
          </div>
          <div class="inline mt-12">
            <button id="importPromptsBtn" class="secondary" type="button">导入并覆盖</button>
            <span id="promptsImportMsg" class="muted"></span>
          </div>

          <div class="divider"></div>
          <div class="section-title">提示词内容</div>

          <div class="accordion open" data-accordion="agent">
            <div class="accordion-header">
              <span class="accordion-title">agent.system</span>
              <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="accordion-content">
              <textarea id="p_agent_system"></textarea>
            </div>
          </div>

          <div class="accordion" data-accordion="diary-system">
            <div class="accordion-header">
              <span class="accordion-title">diary.system</span>
              <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="accordion-content">
              <textarea id="p_diary_system"></textarea>
            </div>
          </div>

          <div class="accordion" data-accordion="diary-user">
            <div class="accordion-header">
              <span class="accordion-title">diary.userTemplate</span>
              <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="accordion-content">
              <textarea id="p_diary_userTemplate"></textarea>
            </div>
          </div>

          <div class="accordion" data-accordion="profile-system">
            <div class="accordion-header">
              <span class="accordion-title">profile.system</span>
              <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="accordion-content">
              <textarea id="p_profile_system"></textarea>
            </div>
          </div>

          <div class="accordion" data-accordion="profile-user">
            <div class="accordion-header">
              <span class="accordion-title">profile.userTemplate</span>
              <svg class="accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="accordion-content">
              <textarea id="p_profile_userTemplate"></textarea>
            </div>
          </div>

	          <div class="inline mt-18">
	            <button id="savePromptsBtn" type="button">保存提示词</button>
	            <button id="resetPromptsBtn" class="secondary" type="button">恢复默认</button>
	            <span id="promptsMsg" class="muted"></span>
	          </div>
	        </div>

        <!-- 日志 Tab -->
        <div id="tab-logs" class="card" role="tabpanel" hidden>
          <div class="muted small">应用层错误日志，内存最多 1000 条，支持实时流。</div>
          <div class="inline mt-10">
            <button id="refreshLogsBtn" class="secondary" type="button">刷新</button>
            <button id="toggleStreamBtn" class="secondary" type="button">开始实时</button>
            <span id="logsMsg" class="muted"></span>
          </div>
          <div id="logsBox" class="log mt-10"></div>
        </div>

        <!-- 对话 Tab -->
        <div id="tab-conversation" class="card" role="tabpanel" hidden>
          <div class="muted small">按 userId 拉取对话日志，用于排障或同步检查。</div>
          <div class="row mt-10">
            <div class="col">
              <label for="convUserId">userId</label>
              <input id="convUserId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
            </div>
            <div class="col">
              <label for="convRole">role（可选）</label>
              <input id="convRole" placeholder="user,atri 或留空" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label for="convAfter">after（timestamp，毫秒）</label>
              <input id="convAfter" placeholder="0" />
            </div>
            <div class="col">
              <label for="convLimit">limit</label>
              <input id="convLimit" placeholder="50" />
            </div>
          </div>
          <div class="inline mt-12">
            <button id="convPullBtn" class="secondary" type="button">拉取</button>
            <button id="convNextBtn" class="secondary" type="button">继续拉取</button>
            <button id="convClearBtn" class="secondary" type="button">清空输出</button>
            <span id="convMsg" class="muted"></span>
          </div>
          <div id="convOut" class="log mt-10"></div>
        </div>
      </div>
    </div>

    <script type="module" src="/admin/assets/app.js"></script>
  </body>
</html>
