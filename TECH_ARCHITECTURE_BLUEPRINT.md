# ATRI æŠ€æœ¯æ¶æ„è“å›¾

<div align="center">

![Version](https://img.shields.io/badge/ç‰ˆæœ¬-1.0.0-blue?style=for-the-badge)
![Updated](https://img.shields.io/badge/æ›´æ–°æ—¥æœŸ-2025--01--15-green?style=for-the-badge)
![Language](https://img.shields.io/badge/è¯­è¨€-ç®€ä½“ä¸­æ–‡-red?style=for-the-badge)

**è®©ä»»ä½•äºº 10 åˆ†é’Ÿå†…ç†è§£æ¶æ„å…¨è²Œã€æ ¸å¿ƒé“¾è·¯ã€ç«¯å£ä¸æ‰©å±•æ–¹å¼**

[English README â†’](README.md)

</div>

---

## ğŸ“‘ ç›®å½•

- [1. æ¶æ„æ€»è§ˆ](#1-æ¶æ„æ€»è§ˆ)
- [2. æ ¸å¿ƒæ•°æ®æµ](#2-æ ¸å¿ƒæ•°æ®æµ)
- [3. æ–‡ä»¶ç»“æ„](#3-æ–‡ä»¶ç»“æ„)
- [4. API ç«¯ç‚¹](#4-api-ç«¯ç‚¹)
- [5. æ•°æ®æ¨¡å‹](#5-æ•°æ®æ¨¡å‹)
- [6. é…ç½®ç¤ºä¾‹](#6-é…ç½®ç¤ºä¾‹)
- [7. éƒ¨ç½²æŒ‡å—](#7-éƒ¨ç½²æŒ‡å—)
- [8. å¸¸ç”¨å‘½ä»¤](#8-å¸¸ç”¨å‘½ä»¤)
- [9. æ•…éšœæ’æŸ¥](#9-æ•…éšœæ’æŸ¥)
- [10. æ‰©å±•å¼€å‘](#10-æ‰©å±•å¼€å‘)
- [11. æ€§èƒ½ä¸é™åˆ¶](#11-æ€§èƒ½ä¸é™åˆ¶)
- [12. å®‰å…¨æ¸…å•](#12-å®‰å…¨æ¸…å•)
- [13. è·¯çº¿å›¾](#13-è·¯çº¿å›¾)

---

## 1. æ¶æ„æ€»è§ˆ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                               ğŸ“± ç”¨æˆ·äº¤äº’å±‚                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚  Android App (Kotlin + Jetpack Compose)                                 â”‚  â•‘
â•‘  â”‚  â”œâ”€â”€ ğŸ  æ¬¢è¿é¡µ  â”œâ”€â”€ ğŸ’¬ èŠå¤©  â”œâ”€â”€ ğŸ“” æ—¥è®°  â”œâ”€â”€ âš™ï¸ è®¾ç½®                    â”‚  â•‘
â•‘  â”‚  â””â”€â”€ Room æœ¬åœ°å­˜å‚¨ + DataStore åå¥½                                      â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                       â”‚
                                       â–¼ HTTP/JSON
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          â˜ï¸ æœåŠ¡å±‚ (Cloudflare Worker)                         â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â•‘
â•‘  â”‚ ğŸ’¬ /api/v1/  â”‚  â”‚ ğŸ“ /conver-  â”‚  â”‚ ğŸ“” /diary    â”‚  â”‚ ğŸ–¼ï¸ /media    â”‚       â•‘
â•‘  â”‚    chat      â”‚  â”‚   sation     â”‚  â”‚              â”‚  â”‚              â”‚       â•‘
â•‘  â”‚  Bio-Agent   â”‚  â”‚  æ—¥å¿—ç®¡ç†     â”‚  â”‚  æ—¥è®°æŸ¥è¯¢    â”‚  â”‚  é™„ä»¶ä¸Šä¼      â”‚       â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â•‘
â•‘         â”‚                 â”‚                 â”‚                 â”‚               â•‘
â•‘         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â•‘
â•‘                                    â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚                        ğŸ”§ æ ¸å¿ƒæœåŠ¡ (services/)                           â”‚  â•‘
â•‘  â”‚  agent-service â”‚ diary-generator â”‚ memory-service â”‚ media-signature    â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                    â”‚                                          â•‘
â•‘                                    â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚                    â° Cron Job (æ¯æ—¥ UTC 15:59)                          â”‚  â•‘
â•‘  â”‚               diary-cron.ts â†’ æ—¥è®°ç”Ÿæˆ + daily learning                  â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                       â”‚
                                       â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                ğŸ’¾ å­˜å‚¨å±‚                                       â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â•‘
â•‘  â”‚  ğŸ—„ï¸ D1       â”‚  â”‚ ğŸ§  Vectorize â”‚  â”‚  ğŸ“¦ R2       â”‚  â”‚ ğŸ¤– OpenAI    â”‚       â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚       â•‘
â•‘  â”‚  â€¢ ä¼šè¯æ—¥å¿—   â”‚  â”‚  â€¢ æ—¥è®°å‘é‡   â”‚  â”‚  â€¢ ç”¨æˆ·é™„ä»¶   â”‚  â”‚  â€¢ Chat API  â”‚       â•‘
â•‘  â”‚  â€¢ æ—¥è®°æ¡ç›®   â”‚  â”‚  â€¢ è®°å¿†æ£€ç´¢   â”‚  â”‚  â€¢ å›¾ç‰‡/æ–‡æ¡£  â”‚  â”‚  â€¢ Embedding â”‚       â•‘
â•‘  â”‚  â€¢ æ¯æ—¥å¤ç›˜   â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚       â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 1.1 ç³»ç»Ÿè§’è‰²

| è§’è‰² | è·¯å¾„ | æŠ€æœ¯æ ˆ | èŒè´£ |
|:-----|:-----|:-------|:-----|
| ğŸ“± **Android å®¢æˆ·ç«¯** | `ATRI/` | Kotlin + Compose + Room + Retrofit + Koin | UI äº¤äº’ã€æœ¬åœ°å­˜å‚¨ã€API è°ƒç”¨ |
| â˜ï¸ **Cloudflare Worker** | `worker/` | TypeScript + itty-router + D1 + R2 + Vectorize | REST APIã€AI è°ƒç”¨ã€å®šæ—¶ä»»åŠ¡ |
| ğŸ“ **å…±äº«æç¤ºè¯** | `shared/` | JSON | äººæ ¼/æ—¥è®°/è®°å¿†æç¤ºè¯çš„å”¯ä¸€æ¯æœ¬ |
| ğŸ”„ **åŒæ­¥è„šæœ¬** | `scripts/` | Python | æŠŠ `shared/prompts.json` åŒæ­¥åˆ° Worker |

---

## 2. æ ¸å¿ƒæ•°æ®æµ

### 2.1 èŠå¤©æµç¨‹

```
                              ğŸ‘¤ ç”¨æˆ·è¾“å…¥
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ğŸ“± Android å®¢æˆ·ç«¯                                 â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ChatScreen    â”‚ â”€â”€â”€â”€â”€â”€â–¶  â”‚  ChatRepository â”‚ â”€â”€â”€â”€â”€â”€â–¶  â”‚ POST /uploadâ”‚ â”‚
â”‚  â”‚  (Compose UI)   â”‚          â”‚   (é™„ä»¶ä¸Šä¼ )     â”‚          â”‚  (R2 å­˜å‚¨)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â˜ï¸ Worker: POST /api/v1/chat                        â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         ğŸ“‹ System Prompt          â”‚    â”‚       ğŸ”„ å·¥å…·å¾ªç¯ (â‰¤3è½®)       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚                               â”‚â”‚
â”‚  â”‚  â”‚ â€¢ ğŸ­ äººè®¾                    â”‚  â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚â”‚
â”‚  â”‚  â”‚ â€¢ â° è®¾å¤‡æ—¶é—´/åå­—           â”‚  â”‚    â”‚   â”‚  ğŸ“– read_diary      â”‚â—€â”€â”€â”€â”€â”¼â”¼â”€â”€â”
â”‚  â”‚  â”‚ â€¢ ğŸ˜Š PAD çŠ¶æ€               â”‚  â”‚    â”‚   â”‚  ğŸ˜Š update_mood     â”‚â”€â”€â”€â”€â”€â”¼â”¼â”€â”€â”¼â”€â–¶ Vectorize
â”‚  â”‚  â”‚ â€¢ ğŸ’¬ ä»Šæ—¥å¯¹è¯               â”‚  â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚                               â”‚â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚                                                                             â”‚  â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          ğŸ“¤ JSON Response                                â”‚  â”‚
â”‚  â”‚         { reply, mood: {p, a, d}, intimacy, action }                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ“± Room å†™å…¥ + UI æ›´æ–°                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **ğŸ“Œ è¯´æ˜**
> - System Prompt å½“å‰ä»…æ³¨å…¥å½“æ—¥å·¥ä½œè®°å¿†ï¼ˆä¸æˆªæ–­ï¼‰ï¼Œå†å²æ—¥è®°/å¤ç›˜éœ€æ¨¡å‹åœ¨å¯¹è¯ä¸­è°ƒç”¨ `read_diary` å·¥å…·æŒ‰éœ€æ£€ç´¢
> - `/api/v1/chat` è¿”å›ä¸€æ¬¡æ€§ JSONï¼ˆéæµå¼ï¼‰

---

### 2.2 æ—¥è®°ç”Ÿæˆæµç¨‹ (Cron)

```
                              â° UTC 15:59 è§¦å‘
                                     â”‚
                                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ“‹ listPendingDiaryUsers()                                         â”‚
    â”‚  â†’ æ‰¾å‡ºã€Œä»Šæ—¥æœ‰å¯¹è¯ ä¸” æ—  ready æ—¥è®°ã€çš„ç”¨æˆ·                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ“ æ‹¼æ¥ä»Šæ—¥å¯¹è¯     â”‚               â”‚  ğŸ“… è®¡ç®—è·ä¸Šæ¬¡èŠå¤©   â”‚
    â”‚     transcript      â”‚               â”‚    å¤©æ•° (å¢å¼ºæ„Ÿæƒ…)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    ğŸ¤– LLM ç”Ÿæˆæ—¥è®°       â”‚
                     â”‚  { diary, highlights,   â”‚
                     â”‚    mood }               â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                     â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸ—„ï¸ D1 å†™å…¥     â”‚   â”‚  ğŸ§  Vectorize   â”‚   â”‚  ğŸ“š Daily       â”‚
    â”‚  diary_entries  â”‚   â”‚    upsert       â”‚   â”‚    Learning     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ–‡ä»¶ç»“æ„

```
ğŸ“ é¡¹ç›®æ ¹ç›®å½•
â”‚
â”œâ”€â”€ ğŸ“ ATRI/                              # ğŸ“± Android å®¢æˆ·ç«¯
â”‚   â””â”€â”€ app/src/main/
â”‚       â”œâ”€â”€ java/me/atri/                 # UI / æ•°æ® / ç½‘ç»œ / Room / DataStore
â”‚       â””â”€â”€ res/                          # å›¾æ ‡ã€å¸ƒå±€ç­‰èµ„æº
â”‚   ï¼ˆå½“å‰ Android ç«¯ä¸å†…ç½® prompts.jsonï¼Œæç¤ºè¯åªåœ¨åç«¯ç”Ÿæ•ˆï¼‰
â”‚
â”œâ”€â”€ ğŸ“ worker/                            # â˜ï¸ Cloudflare Worker åç«¯
â”‚   â”œâ”€â”€ ğŸ“„ wrangler.toml                  # èµ„æºç»‘å®š + Cron é…ç½®
â”‚   â”œâ”€â”€ ğŸ“ db/
â”‚   â”‚   â””â”€â”€ ğŸ“„ schema.sql                 # D1 è¡¨ç»“æ„
â”‚   â””â”€â”€ ğŸ“ src/
â”‚       â”œâ”€â”€ ğŸ“„ index.ts                   # è·¯ç”±æ³¨å†Œ + scheduled é’©å­
â”‚       â”œâ”€â”€ ğŸ“ routes/                    # chat / conversation / diary / media / admin / models
â”‚       â”œâ”€â”€ ğŸ“ services/                  # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚       â”œâ”€â”€ ğŸ“„ jobs/diary-cron.ts         # å®šæ—¶ä»»åŠ¡
â”‚       â””â”€â”€ ğŸ“ config/
â”‚           â””â”€â”€ ğŸ“„ prompts.json           # ç”±è„šæœ¬ä» shared åŒæ­¥
â”‚
â”œâ”€â”€ ğŸ“ shared/
â”‚   â””â”€â”€ ğŸ“„ prompts.json                   # ğŸ¯ äººæ ¼/æ—¥è®°/è®°å¿†æç¤ºè¯æ¯æœ¬ï¼ˆå”¯ä¸€çœŸç›¸æºï¼‰
â”‚
â””â”€â”€ ğŸ“ scripts/
    â””â”€â”€ ğŸ“„ sync_shared.py                 # ğŸ”„ æŠŠ shared/prompts.json åŒæ­¥åˆ° worker
```

---

## 4. API ç«¯ç‚¹

### 4.1 ç«¯ç‚¹åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | é‰´æƒ | è¯´æ˜ |
|:----:|:-----|:----:|:-----|
| `POST` | `/api/v1/chat` | ğŸ” X-App-Token | ä¸»èŠå¤©æ¥å£ï¼Œè¿”å› `{reply, mood:{p,a,d}, intimacy, action}` |
| `POST` | `/conversation/log` | ğŸ” X-App-Token | è®°å½•å•æ¡å¯¹è¯ |
| `POST` | `/conversation/delete` | ğŸ” X-App-Token | åˆ é™¤è‹¥å¹²æ—¥å¿— |
| `GET` | `/conversation/last` | ğŸ” X-App-Token | æŸ¥è¯¢ä¸Šæ¬¡å¯¹è¯æ—¶é—´ |
| `GET` | `/diary` | ğŸ” X-App-Token | æŸ¥è¯¢å•æ—¥æ—¥è®° |
| `GET` | `/diary/list` | ğŸ” X-App-Token | æ—¥è®°åˆ—è¡¨ï¼ˆå€’åºï¼‰ |
| `POST` | `/upload` | ğŸ” X-App-Token | é™„ä»¶ä¸Šä¼ åˆ° R2 |
| `GET` | `/media/:key` | ğŸ” X-App-Token / ç­¾å URL / token | è¯»å–é™„ä»¶ï¼ˆApp ç”¨ Headerï¼Œæ¨¡å‹ç”¨ç­¾å URLï¼‰ |
| `GET` | `/media-s/:exp/:sig/:key` | ğŸ” X-App-Token / ç­¾å URL / token | ç»™æ¨¡å‹ç”¨çš„è·¯å¾„ç­¾ååª’ä½“åœ°å€ï¼ˆé¿å… query ä¸¢å¤±ï¼‰ |
| `GET` | `/models` | ğŸ” X-App-Token | è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨ |
| `POST` | `/admin/clear-user` | ğŸ”’ Bearer Token | æ¸…ç†ç”¨æˆ·æ•°æ®ï¼ˆéœ€ ADMIN_API_KEYï¼‰ |

### 4.2 è¯·æ±‚/å“åº”ç¤ºä¾‹

<details>
<summary><b>ğŸ“¤ POST /api/v1/chat</b></summary>

**Request**
```json
{
  "userId": "uuid-xxx",
  "content": "ä»Šå¤©å¥½ç´¯å•Š",
  "logId": "log-uuid",
  "userName": "å°æ˜",
  "clientTimeIso": "2025-01-15T22:30:00+08:00",
  "modelKey": "gpt-4",
  "attachments": []
}
```

**Response**
```json
{
  "reply": "è¾›è‹¦äº†å‘¢ï¼Œè¦ä¸è¦è·Ÿæˆ‘è¯´è¯´ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ",
  "mood": { "p": 0.62, "a": 0.35, "d": 0.48 },
  "intimacy": 12,
  "action": null
}
```
</details>

<details>
<summary><b>ğŸ“¤ POST /conversation/log</b></summary>

**Request**
```json
{
  "userId": "uuid-xxx",
  "role": "user",
  "content": "ä»Šå¤©å¥½ç´¯å•Š",
  "timestamp": 1705329000000,
  "timeZone": "Asia/Shanghai"
}
```

**Response**
```json
{
  "ok": true,
  "id": "log-uuid",
  "date": "2025-01-15"
}
```
</details>

---

## 5. æ•°æ®æ¨¡å‹

### 5.1 D1 è¡¨ç»“æ„

<details>
<summary><b>ğŸ“‹ conversation_logs</b></summary>

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|:-----|:----:|:-----|
| `id` | TEXT PK | UUID |
| `user_id` | TEXT | ç”¨æˆ·æ ‡è¯† |
| `date` | TEXT | yyyy-MM-ddï¼ˆæŒ‰æ—¶åŒºè®¡ç®—ï¼‰ |
| `role` | TEXT | `user` / `atri` |
| `content` | TEXT | æ¶ˆæ¯å†…å®¹ |
| `attachments` | TEXT | JSON æ•°ç»„ |
| `timestamp` | INTEGER | æ¯«ç§’æ—¶é—´æˆ³ |
| `created_at` | INTEGER | å†™å…¥æ—¶é—´ |</details>

<details>
<summary><b>ğŸ“” diary_entries</b></summary>

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|:-----|:----:|:-----|
| `id` | TEXT PK | `diary:<userId>:<date>` |
| `user_id` | TEXT | ç”¨æˆ·æ ‡è¯† |
| `date` | TEXT | yyyy-MM-dd |
| `summary` | TEXT | åˆ—è¡¨æ‘˜è¦ |
| `content` | TEXT | æ—¥è®°æ­£æ–‡ |
| `mood` | TEXT | å¿ƒæƒ…æ ‡ç­¾ |
| `status` | TEXT | `ready` / `pending` / `error` |
</details>

<details>
<summary><b>ğŸ“š daily_learning</b></summary>

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|:-----|:----:|:-----|
| `id` | TEXT PK | `learn:<userId>:<date>` |
| `user_id` | TEXT | ç”¨æˆ·æ ‡è¯† |
| `date` | TEXT | yyyy-MM-dd |
| `summary` | TEXT | äº®ç‚¹/é—®é¢˜æ¦‚è¦ |
| `payload` | TEXT | å®Œæ•´ JSON |
</details>

### 5.2 Vectorize å…ƒæ•°æ®

| å­—æ®µ | è¯´æ˜ |
|:-----|:-----|
| `id` | `diary:<userId>:<date>` |
| `metadata.u` | userId |
| `metadata.c` | ç±»å‹ï¼ˆå›ºå®š `diary`ï¼‰ |
| `metadata.d` | æ—¥æœŸ |
| `metadata.m` | å¿ƒæƒ… |

---

## 6. é…ç½®ç¤ºä¾‹

### 6.1 wrangler.toml

```toml
name = "atri-worker"
main = "src/index.ts"
compatibility_date = "2024-01-01"
account_id = "your-account-id"

[vars]
OPENAI_API_URL = "https://api.openai.com/v1"
DIARY_API_URL = "https://api.openai.com/v1"          # å¯é€‰ï¼šæ—¥è®°ä¸“ç”¨ä¸Šæ¸¸
DIARY_MODEL = "gpt-4"
EMBEDDINGS_API_URL = "https://api.siliconflow.cn/v1"     # é»˜è®¤ï¼šå‘é‡/åµŒå…¥ä¸Šæ¸¸ï¼ˆOpenAI å…¼å®¹ï¼‰
EMBEDDINGS_API_KEY = "your-embeddings-key"              # å¯é€‰ï¼šè¦†ç›–é»˜è®¤ï¼ˆä¹Ÿå¯ç”¨ wrangler secretï¼‰
EMBEDDINGS_MODEL = "BAAI/bge-m3"                        # é»˜è®¤ 1024 ç»´

[[vectorize]]
binding = "VECTORIZE"
index_name = "atri-memories"

[[r2_buckets]]
binding = "MEDIA_BUCKET"
bucket_name = "atri-media"
preview_bucket_name = "atri-media"

[[d1_databases]]
binding = "ATRI_DB"
database_name = "atri_diary"
database_id = "your-d1-id"

[triggers]
crons = ["59 15 * * *"]  # UTC 15:59 = åŒ—äº¬æ—¶é—´ 23:59
```

### 6.2 prompts.json ç»“æ„

```json
{
  "chat": {
    "identity": "...",
    "soul": "...",
    "memoryWhispers": "...",
    "voice": "...",
    "innerProcess": "...",
    "naturalness": "..."
  },
  "diary": {
    "system": "...",
    "userTemplate": "..."
  },
  "profile": {
    "system": "...",
    "userTemplate": "..."
  },
  "summary": { "prompt": "..." },
  "memory": { "extractTemplate": "..." },
  "agent": { "system": "..." }
}
```

---

## 7. éƒ¨ç½²æŒ‡å—

### 7.1 ç¯å¢ƒå‡†å¤‡

```bash
# 1ï¸âƒ£ å…‹éš†é¡¹ç›®
git clone <repo> && cd ATRI

# 2ï¸âƒ£ å®‰è£… Worker ä¾èµ–
cd worker && npm install

# 3ï¸âƒ£ ç™»å½• Cloudflare
npx wrangler login

# 4ï¸âƒ£ åˆ›å»º D1 æ•°æ®åº“
npx wrangler d1 create atri_diary
npx wrangler d1 execute atri_diary --file=db/schema.sql

# 5ï¸âƒ£ åˆ›å»º R2 å­˜å‚¨æ¡¶
npx wrangler r2 bucket create atri-media

# 6ï¸âƒ£ åˆ›å»º Vectorize ç´¢å¼•
npx wrangler vectorize create atri-memories --dimensions=1024 --metric=cosine

# 7ï¸âƒ£ é…ç½® Secrets
npx wrangler secret put OPENAI_API_KEY
npx wrangler secret put EMBEDDINGS_API_KEY  # å¯é€‰ï¼šè¦†ç›–é»˜è®¤ embeddings key
npx wrangler secret put APP_TOKEN
npx wrangler secret put MEDIA_SIGNING_KEY   # å¯é€‰ï¼šåª’ä½“ç­¾åå¯†é’¥ï¼ˆä¸é…åˆ™å›é€€ APP_TOKENï¼‰
npx wrangler secret put ADMIN_API_KEY  # å¯é€‰
```

### 7.2 éƒ¨ç½²

```bash
# ğŸ”„ åŒæ­¥æç¤ºè¯
python3 scripts/sync_shared.py

# â˜ï¸ éƒ¨ç½² Worker
cd worker && npm run deploy

# ğŸ“± æ„å»º Android
cd ATRI && ./gradlew assembleRelease
```

### 7.3 ç¯å¢ƒçŸ©é˜µ

| åœºæ™¯ | Android å…¥å£ | Worker | è¯´æ˜ |
|:-----|:-------------|:-------|:-----|
| ğŸ”§ æœ¬åœ°å¼€å‘ | `http://10.0.2.2:8787` | `npm run dev` | æ¨¡æ‹Ÿå™¨ä½¿ç”¨ |
| ğŸ“± çœŸæœºè°ƒè¯• | `http://<å±€åŸŸç½‘IP>:8787` | `npm run dev` | åŒä¸€ WiFi |
| ğŸš€ ç”Ÿäº§ç¯å¢ƒ | `https://your.workers.dev` | `npm run deploy` | éœ€é…ç½® Secrets |

---

## 8. å¸¸ç”¨å‘½ä»¤

| åœºæ™¯ | å‘½ä»¤ |
|:-----|:-----|
| ğŸ”„ åŒæ­¥æç¤ºè¯ | `python3 scripts/sync_shared.py` |
| ğŸ”§ Worker æœ¬åœ°å¼€å‘ | `cd worker && npm run dev` |
| ğŸŒ Worker è¿œç¨‹è°ƒè¯• | `cd worker && npm run dev -- --remote` |
| ğŸš€ Worker éƒ¨ç½² | `cd worker && npm run deploy` |
| ğŸ“‹ æŸ¥çœ‹å®æ—¶æ—¥å¿— | `cd worker && npx wrangler tail --format pretty` |
| ğŸ—„ï¸ D1 æŸ¥è¯¢ | `npx wrangler d1 execute atri_diary --command "SELECT ..."` |
| ğŸ§  Vectorize çŠ¶æ€ | `npx wrangler vectorize info atri-memories` |
| ğŸ“± Android å®‰è£… | `cd ATRI && ./gradlew installDebug` |
| ğŸ§¹ Android æ¸…ç† | `cd ATRI && ./gradlew clean` |

---

## 9. æ•…éšœæ’æŸ¥

### 9.1 å¸¸è§é—®é¢˜

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | æ’æŸ¥æ­¥éª¤ |
|:-----|:---------|:---------|
| âŒ èŠå¤©æ— å“åº” | API Key æ— æ•ˆ | æ£€æŸ¥ `wrangler secret list`ï¼Œç¡®è®¤ `OPENAI_API_KEY` å·²è®¾ç½® |
| â±ï¸ èŠå¤©è¶…æ—¶ | æ¨¡å‹å“åº”æ…¢ | æŸ¥çœ‹ `wrangler tail`ï¼Œè€ƒè™‘é™ä½ `max_tokens` æˆ–æ¢æ¨¡å‹ |
| ğŸ“” æ—¥è®°æœªç”Ÿæˆ | Cron æœªè§¦å‘ | æ£€æŸ¥ `wrangler cron triggers`ï¼Œç¡®è®¤æ—¶åŒºé…ç½® |
| âš ï¸ æ—¥è®°ç”Ÿæˆå¤±è´¥ | D1/Vectorize é”™è¯¯ | æŸ¥çœ‹ `diary_entries.status = 'error'` çš„è®°å½• |
| ğŸ“¤ é™„ä»¶ä¸Šä¼ å¤±è´¥ | R2 æœªç»‘å®š | ç¡®è®¤ `wrangler.toml` ä¸­ `MEDIA_BUCKET` é…ç½®æ­£ç¡® |
| ğŸ” å‘é‡æ£€ç´¢æ— ç»“æœ | Embedding å¤±è´¥ | æ£€æŸ¥ `EMBEDDINGS_API_KEY`ï¼ŒæŸ¥çœ‹ Vectorize æ¡æ•° |
| ğŸ“± Android è¿ä¸ä¸Š | URL é”™è¯¯ | æ¨¡æ‹Ÿå™¨ç”¨ `10.0.2.2`ï¼ŒçœŸæœºç”¨å±€åŸŸç½‘ IP |
| ğŸ“ æç¤ºè¯ä¸ä¸€è‡´ | æœªåŒæ­¥ | è¿è¡Œ `sync_shared.py` åé‡æ–°éƒ¨ç½² |

### 9.2 æ—¥å¿—æŸ¥çœ‹

```bash
# ğŸ“‹ å®æ—¶æ—¥å¿—
npx wrangler tail --format pretty

# âš ï¸ è¿‡æ»¤é”™è¯¯
npx wrangler tail --format pretty | grep -i error

# ğŸ—„ï¸ D1 æ£€æŸ¥å¤±è´¥æ—¥è®°
npx wrangler d1 execute atri_diary --command \
  "SELECT * FROM diary_entries WHERE status = 'error' ORDER BY date DESC LIMIT 5"
```

### 9.3 æ‰‹åŠ¨è§¦å‘ Cron

```typescript
// åœ¨ Worker ä¸­ä¸´æ—¶æ·»åŠ æµ‹è¯•è·¯ç”±
router.get('/debug/cron', async (req, env) => {
  await runDiaryCron(env, '2025-01-15');  // æŒ‡å®šæ—¥æœŸ
  return new Response('Done');
});
```

---

## 10. æ‰©å±•å¼€å‘

### 10.1 ä¿®æ”¹äººæ ¼/æç¤ºè¯

1. âœï¸ ç¼–è¾‘ `shared/prompts.json`
2. ğŸ”„ è¿è¡Œ `python3 scripts/sync_shared.py`
3. ğŸš€ é‡æ–°éƒ¨ç½² Worker + é‡å¯ Android

### 10.2 æ·»åŠ æ–°è®°å¿†ç±»å‹

```typescript
// 1ï¸âƒ£ å®šä¹‰æ–°çš„ metadata ç±»å‹
interface UserPreferenceMetadata {
  u: string;       // userId
  c: 'preference'; // ç±»å‹æ ‡è¯†
  k: string;       // åå¥½é”®å
  ts: number;
}

// 2ï¸âƒ£ å†™å…¥å‘é‡
await env.VECTORIZE.upsert([{
  id: `pref:${userId}:${key}`,
  values: embedding,
  metadata: { u: userId, c: 'preference', k: key, ts: Date.now() }
}]);

// 3ï¸âƒ£ åœ¨ composeSystemPrompt ä¸­æ£€ç´¢å¹¶æ³¨å…¥
```

### 10.3 æ·»åŠ æ–° API ç«¯ç‚¹

```typescript
// 1ï¸âƒ£ worker/src/routes/new-feature.ts
import { Router } from 'itty-router';
export const newFeatureRouter = Router({ base: '/new-feature' });

newFeatureRouter.get('/', async (req, env) => {
  return Response.json({ hello: 'world' });
});

// 2ï¸âƒ£ worker/src/index.ts
import { newFeatureRouter } from './routes/new-feature';
router.all('/new-feature/*', newFeatureRouter.handle);

// 3ï¸âƒ£ Android: AtriApiService.kt
@GET("new-feature")
suspend fun getNewFeature(): Response<NewFeatureResponse>
```

---

## 11. æ€§èƒ½ä¸é™åˆ¶

| èµ„æº | å…è´¹å±‚é™åˆ¶ | å»ºè®® |
|:-----|:-----------|:-----|
| ğŸ—„ï¸ D1 è¯»å– | 5M æ¬¡/å¤© | é€‚åˆ 10K DAU |
| âœï¸ D1 å†™å…¥ | 100K æ¬¡/å¤© | åˆå¹¶æ‰¹é‡å†™å…¥ |
| ğŸ§  Vectorize | 100K å‘é‡ | å®šæœŸæ¸…ç†æ—§æ—¥è®° |
| ğŸ“¦ R2 å­˜å‚¨ | 10GB | å®¢æˆ·ç«¯å‹ç¼©å›¾ç‰‡ |
| â˜ï¸ Worker è¯·æ±‚ | 100K æ¬¡/å¤© | åŠ ç¼“å­˜å‡å°‘é‡å¤è°ƒç”¨ |
| â±ï¸ å•æ¬¡è¯·æ±‚ | 30s CPU / 128MB | OpenAI è¶…æ—¶è®¾ 120s |

### ğŸ’¾ Working Memory ç­–ç•¥

**å½“å‰å®ç°**ï¼šå½“æ—¥å¯¹è¯å…¨é‡æ³¨å…¥ï¼ˆä¸æˆªæ–­ï¼‰ï¼ŒæŒ‰å®¢æˆ·ç«¯æ—¶åŒºæ’åºã€‚

**å¦‚éœ€æ§é‡å¯æŒ‰éœ€æ”¹é€ **ï¼š
- ä¿ç•™å‰ 20 æ¡ï¼ˆå¼€åœºä¸Šä¸‹æ–‡ï¼‰
- ä¿ç•™å 50 æ¡ï¼ˆæœ€è¿‘å¯¹è¯ï¼‰
- ä¸­é—´æ’å…¥ `[... çœç•¥ N æ¡å¯¹è¯ ...]`

---

## 12. å®‰å…¨æ¸…å•

- [ ] ğŸ” æ‰€æœ‰ Secrets é€šè¿‡ `wrangler secret put` è®¾ç½®ï¼Œä¸æäº¤ `.dev.vars`
- [ ] ğŸ”‘ `/api/v1/chat` ç­‰æ¥å£å¯ç”¨ `X-App-Token` éªŒè¯
- [ ] ğŸ›¡ï¸ `/admin/*` æ¥å£å¯ç”¨ `ADMIN_API_KEY` ä¿æŠ¤
- [ ] ğŸ“ `/upload` æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå»ºè®® 10MBï¼‰
- [ ] ğŸ”’ ç”Ÿäº§ç¯å¢ƒå¯ç”¨ Cloudflare Access æˆ– JWT
- [ ] ğŸ” å®šæœŸå®¡è®¡ D1 ä¸­çš„æ•æ„Ÿå†…å®¹

---

## 13. è·¯çº¿å›¾

| çŠ¶æ€ | ä»»åŠ¡ |
|:----:|:-----|
| â¬œ | è¡¥å…¨æ›´å¤šå…³ç³»è¿›å±•æç¤ºè¯ï¼ˆäº²å¯†åº¦/ç›¸å¤„é˜¶æ®µï¼‰ |
| â¬œ | æ¢å¤é•¿æœŸè®°å¿†å†™å…¥ï¼ˆç”¨æˆ·åå¥½ã€ç¦å¿Œï¼‰ |
| â¬œ | å®¢æˆ·ç«¯å±•ç¤º daily learning |
| â¬œ | å¤šç«¯æ¶ˆæ¯åŒæ­¥ï¼ˆæ–°å¢ `/conversation/list`ï¼‰ |
| â¬œ | é™„ä»¶å‹ç¼© + å¤§å°é™åˆ¶ |
| â¬œ | CI æµæ°´çº¿ï¼ˆlint + dry-run deployï¼‰ |

---

## ğŸ“‹ å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|:----:|:----:|:---------|
| 1.0.0 | 2025-12-11 | ğŸ‰ åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´æ¶æ„è¯´æ˜ |

---

<div align="center">

**Made with â¤ï¸ for ATRI**

[â¬†ï¸ è¿”å›é¡¶éƒ¨](#atri-æŠ€æœ¯æ¶æ„è“å›¾)

</div>
